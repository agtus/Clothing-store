<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <style>
    body {
      font-family: Arial;
      background: #f4f4f4;
      padding: 2rem;
    }
    form {
      max-width: 700px;
      margin: 1rem auto;
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label { display: block; margin-top: 1rem; }
    input, textarea, select {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.3rem;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 1rem;
      padding: 0.7rem 1.2rem;
      background: #000;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .product-list {
      max-width: 1000px;
      margin: 2rem auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }
    .product-card {
      background: #fff;
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .product-card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 5px;
    }
    .thumbs img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      margin: 3px;
      border-radius: 5px;
    }
    .message {
      text-align: center;
      margin-top: 1rem;
      font-weight: bold;
    }
    .color-block {
      margin-top: 1rem;
      border-top: 1px dashed #aaa;
      padding-top: 1rem;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center;">üõ†Ô∏è Admin Panel</h1>

  <form id="addForm">
    <h2>Add / Edit Product</h2>
    <label>Name</label>
    <input type="text" name="name" required />
    <label>Price (‚Çπ)</label>
    <input type="text" name="price" required />
    <label>Amount (Paise)</label>
    <input type="text" name="amount" required />
    <label>Description</label>
    <textarea name="desc" required></textarea>

    <label>Available Sizes (hold Ctrl or Cmd to multi-select)</label>
    <select name="sizes" multiple required>
      <option value="S">S</option>
      <option value="M">M</option>
      <option value="L">L</option>
      <option value="XL">XL</option>
    </select>

    <label>Trending</label>
    <select name="trending">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>
    <label>Section</label>
    <select name="section">
      <option value="Women">Women</option>
      <option value="Bedsheets">Bedsheets</option>
      <option value="Raw Materials">Raw Materials</option>
      <option value="Home Decors">Home Decors</option>
    </select>

    <div class="color-block">
      <label>Color Variant</label>
      <input type="text" name="color" placeholder="e.g. Red" required />
      <label>Upload Images for this Color</label>
      <input type="file" id="imageUpload" accept="image/*" multiple />
      <div id="uploadStatus">üì∑ Waiting for images...</div>
    </div>

    <input type="hidden" name="image" id="imageUrls" />

    <button type="submit">üíæ Save Product</button>
    <div class="message" id="addMsg"></div>
  </form>

  <h2 style="text-align:center;">All Products</h2>
  <section class="product-list" id="productList"></section>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxgv5PfjwXGtsVYtwJHwTZmMjRwe1zx_BIbeNYdJytcaqX9ejAzcGQedQocxmWxIGN0wQ/exec";
    const cloudName = 'dxwvqo37k';
    const uploadPreset = 'unsigned_preset';
    let editingId = null;

    document.getElementById('imageUpload').addEventListener('change', async (e) => {
      const files = e.target.files;
      const urls = [];
      document.getElementById('uploadStatus').innerText = 'Uploading...';

      for (let file of files) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', uploadPreset);

        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
          method: 'POST',
          body: formData
        });

        const data = await res.json();
        if (data.secure_url) urls.push(data.secure_url);
      }

      document.getElementById('uploadStatus').innerText = `‚úÖ ${urls.length} image(s) uploaded`;
      document.getElementById('imageUrls').value = urls.join(',');
    });

    document.getElementById("addForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const form = new FormData(this);
      const sizes = Array.from(this.elements["sizes"].selectedOptions).map(o => o.value).join(",");
      form.set("sizes", sizes);

      if (editingId) {
        form.append("id", editingId);
        form.append("action", "edit");
      } else {
        form.append("id", Date.now().toString());
        form.append("action", "add");
      }

      const res = await fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams(form)
      });

      const msg = await res.text();
      document.getElementById("addMsg").innerText = msg === "Added" || msg === "Edited"
        ? `‚úÖ Product ${editingId ? 'updated' : 'added'}!`
        : "‚ùå Error";

      if (msg === "Added" || msg === "Edited") {
        this.reset();
        editingId = null;
        document.getElementById("uploadStatus").innerText = 'üì∑ Waiting for images...';
        loadProducts();
      }
    });

    async function loadProducts() {
      try {
        const res = await fetch(scriptURL);
        const data = await res.json();
        const productList = document.getElementById("productList");
        productList.innerHTML = "";

        data.slice(1).forEach(row => {
          const [id, name, price, image, desc, trending, section, amount, sizes, color] = row;
          const imgArray = image.split(',');
          const card = document.createElement("div");
          card.className = "product-card";
          card.innerHTML = `
            <img src="${imgArray[0]}" alt="${name}" />
            <h4>${name}</h4>
            <p>‚Çπ${price}</p>
            <div class="thumbs">${imgArray.map(i => `<img src="${i}" />`).join('')}</div>
            <button onclick="editProduct('${id}', '${name}', '${price}', '${image}', \`${String(desc || "").replace(/`/g, "\\`")}\`, '${trending}', '${section}', '${amount}', '${sizes}', '${color}')">‚úèÔ∏è Edit</button>
            <button onclick="deleteProduct('${id}')">üóëÔ∏è Delete</button>`;
          productList.appendChild(card);
        });
      } catch (err) {
        console.error("Error loading products:", err);
      }
    }

    function editProduct(id, name, price, image, desc, trending, section, amount, sizes, color) {
      const form = document.getElementById("addForm");
      form.elements["name"].value = name;
      form.elements["price"].value = price;
      form.elements["amount"].value = amount;
      form.elements["desc"].value = desc;
      form.elements["trending"].value = trending;
      form.elements["section"].value = section;
      form.elements["color"].value = color;
      document.getElementById("imageUrls").value = image;
      document.getElementById("uploadStatus").innerText = `üñºÔ∏è Using existing image(s)`;

      // Multi-select sizes
      const selectedSizes = sizes.split(",");
      Array.from(form.elements["sizes"].options).forEach(opt => {
        opt.selected = selectedSizes.includes(opt.value);
      });

      editingId = id;
      document.getElementById("addMsg").innerText = `üîß Editing product...`;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteProduct(id) {
      if (!confirm(`Delete product ID ${id}?`)) return;
      const res = await fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({ id, action: "delete" })
      });
      const msg = await res.text();
      if (msg === "Deleted") {
        alert("‚úÖ Product deleted.");
        loadProducts();
      } else {
        alert("‚ö†Ô∏è Product not found.");
      }
    }

    loadProducts();
  </script>
</body>
</html>
